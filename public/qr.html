<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Generate QR for Trip</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:20px; }
    .card {
      background: #fff; max-width: 400px; margin: auto;
      padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h1 { font-size: 1.5em; margin-bottom: 1em; text-align:center; }
    label, select, button { display: block; width: 100%; margin-bottom: 10px; }
    select, button { padding: 8px; font-size: 1em; border-radius: 4px; border:1px solid #ccc; }
    button { background: #007BFF; color: #fff; border: none; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #qrCanvas { display: block; margin: 20px auto; }
    .error { color: red; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Generate QR for Trip</h1>
    <label for="tripSelect">Select Trip:</label>
    <select id="tripSelect">
      <option>Loading trips…</option>
    </select>
    <button id="generateBtn" disabled>Generate QR</button>
    <canvas id="qrCanvas"></canvas>
    <div id="errorMsg" class="error"></div>
  </div>

  <!-- QRious library to draw QR codes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    const BASE = 'https://quickfare-backend.onrender.com';
    let trips = [];

    // 1) Load trips from public-trips endpoint
    async function loadTrips() {
      const sel = document.getElementById('tripSelect');
      const err = document.getElementById('errorMsg');
      err.textContent = '';
      try {
        const res  = await fetch(`${BASE}/api/public-trips`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        trips = await res.json();

        sel.innerHTML = '<option value="">-- Select a trip --</option>';
        trips.forEach(t => {
          const date = t.date?.split('T')[0] || '—';
          const time = t.time || '—';
          const label = `${t.origin} ➜ ${t.destination} | ${date} ${time}`;
          const opt   = document.createElement('option');
          opt.value   = t.id;
          opt.textContent = label;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error('Failed to load trips', e);
        sel.innerHTML = '<option>Could not load trips</option>';
        err.textContent = '❌ Unable to load trips. Please try again later.';
      }
    }

    // 2) Enable generate button when a trip is selected
    document.getElementById('tripSelect').addEventListener('change', e => {
      document.getElementById('generateBtn').disabled = !e.target.value;
      document.getElementById('errorMsg').textContent = '';
      document.getElementById('qrCanvas').style.display = 'none';
    });

    // 3) Generate QR code with trip payload
    document.getElementById('generateBtn').addEventListener('click', () => {
      const selVal = document.getElementById('tripSelect').value;
      const trip   = trips.find(t => String(t.id) === selVal);
      if (!trip) return;
      const payload = JSON.stringify({
        tripId: trip.id,
        origin: trip.origin,
        destination: trip.destination,
        fare: trip.fare,
        date: trip.date,
        time: trip.time
      });

      const qr = new QRious({
        element: document.getElementById('qrCanvas'),
        value: payload,
        size: 250
      });
      document.getElementById('qrCanvas').style.display = 'block';
    });

    // Initialize
    window.addEventListener('DOMContentLoaded', loadTrips);
  </script>
</body>
</html>
