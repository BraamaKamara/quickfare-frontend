<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuickFare ‚Äì Check Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; margin-bottom: 1rem; }
    #message {
      max-width: 600px;
      margin: 0 auto 1rem;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    #message.error { background: #ffe6e6; color: #900; border: 1px solid #f5c2c2; }
    #message.success { background: #e6ffed; color: #090; border: 1px solid #c2f5c2; }
    #checkForm {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #checkForm > * { margin: 0.5rem 0; }
    button, select, input {
      font-size: 1rem;
    }
    select, input[type="tel"] {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      cursor: pointer;
    }
    #scanner {
      width: 100%;
      max-width: 400px;
      margin: 1rem auto;
    }
    #result { margin-top: 1rem; font-weight: bold; }
  </style>
  <!-- html5-qrcode library for scanning -->
  <script src="https://unpkg.com/html5-qrcode@latest/dist/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>üîç Check Passenger Payment</h1>
  <div id="message"></div>

  <div id="checkForm">
    <button id="startScanBtn">üì∑ Scan Trip QR</button>
    <div id="scanner" style="display:none;"></div>

    <label for="tripSelect">Or select trip:</label>
    <select id="tripSelect">
      <option value="">-- Loading trips‚Ä¶ --</option>
    </select>

    <label for="phoneInput">Passenger Phone:</label>
    <input type="tel" id="phoneInput" placeholder="09XXXXXXXX" pattern="09\d{8}" />

    <button id="checkBtn">‚úÖ Check Payment</button>

    <div id="result"></div>
  </div>

  <script>
    const BASE = 'https://quickfare-backend.onrender.com';
    const msgEl     = document.getElementById('message');
    const scannerEl = document.getElementById('scanner');
    const startBtn  = document.getElementById('startScanBtn');
    const tripSelect= document.getElementById('tripSelect');
    const phoneIn   = document.getElementById('phoneInput');
    const checkBtn  = document.getElementById('checkBtn');
    const resultEl  = document.getElementById('result');
    let html5Scanner = null;

    function showMessage(text, type='error') {
      msgEl.textContent = text;
      msgEl.className = type;
      msgEl.style.display = 'block';
    }
    function clearMessage() {
      msgEl.style.display = 'none';
    }
    function clearResult() {
      resultEl.textContent = '';
    }

    // 1) Load trips into dropdown
    async function loadTrips() {
      tripSelect.innerHTML = '<option>Loading‚Ä¶</option>';
      try {
        const res = await fetch(`${BASE}/api/public-trips`);
        if (!res.ok) throw new Error('Failed to load trips');
        const trips = await res.json();
        if (!trips.length) {
          tripSelect.innerHTML = '<option value="">No trips available</option>';
          return;
        }
        tripSelect.innerHTML = `<option value="">-- Select trip --</option>` +
          trips.map(t => {
            const d = new Date(t.date).toISOString().slice(0,10);
            return `<option value="${t.id}">
              ${t.origin} ‚Üí ${t.destination} | ${d} ${t.time}
            </option>`;
          }).join('');
      } catch (err) {
        tripSelect.innerHTML = '<option value="">Error loading trips</option>';
        showMessage(err.message, 'error');
      }
    }

    // 2) Kick off QR scanner
    startBtn.addEventListener('click', () => {
      clearMessage(); clearResult();
      if (!html5Scanner) {
        html5Scanner = new Html5Qrcode("scanner");
      }
      startBtn.disabled = true;
      scannerEl.style.display = 'block';
      const config = { fps: 10, qrbox: 250 };
      Html5Qrcode.getCameras()
        .then(cameras => {
          const cameraId = cameras[0].id;
          html5Scanner.start(
            cameraId,
            config,
            (decoded) => {
              // on success
              try {
                const obj = JSON.parse(decoded);
                if (obj.id) {
                  tripSelect.value = obj.id;
                  showMessage('‚úÖ Trip selected from QR', 'success');
                } else {
                  throw new Error('No tripId in QR');
                }
              } catch {
                showMessage('‚ö†Ô∏è Invalid QR payload', 'error');
              }
              html5Scanner.stop();
              scannerEl.style.display = 'none';
              startBtn.disabled = false;
            },
            (err) => {
              // ignore scan errors
            }
          ).catch(err => {
            showMessage('‚ùå Scanner error: ' + err, 'error');
            startBtn.disabled = false;
          });
        })
        .catch(err => {
          showMessage('‚ùå Could not access camera', 'error');
          startBtn.disabled = false;
        });
    });

    // 3) Check payment
    checkBtn.addEventListener('click', async () => {
      clearMessage(); clearResult();
      const tripId = tripSelect.value;
      const phone  = phoneIn.value.trim();
      if (!tripId) {
        return showMessage('Select or scan a trip first');
      }
      if (!/^09\d{8}$/.test(phone)) {
        return showMessage('Enter a valid Zambian phone (09XXXXXXXX)');
      }

      try {
        const res = await fetch(
          `${BASE}/api/payments/check?tripId=${tripId}&phone=${phone}`
        );
        if (res.status === 404) {
          resultEl.textContent = '‚ùå Payment not found.';
          return;
        }
        if (!res.ok) throw new Error('Error checking payment');
        const data = await res.json();
        resultEl.textContent = 
          `‚úÖ Payment found! Amount: ZMW ${data.payment.amountPaid}, ` +
          `Method: ${data.payment.paymentMethod}, Status: ${data.payment.status}`;
      } catch (err) {
        showMessage(err.message, 'error');
      }
    });

    // initialize
    loadTrips();
  </script>
</body>
</html>
