<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîç Check Passenger Payment</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    .section { background: #fff; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
    label, button, select, input { display: block; width: 100%; margin: 10px 0; }
    select, input { padding: 8px; font-size: 1rem; }
    button { padding: 10px; font-size: 1rem; cursor: pointer; }
    #scanner { margin-top: 20px; }
    #message { margin-top: 20px; font-size: 1rem; }
    #message.success { color: green; }
    #message.error   { color: red; }
  </style>
  <!-- HTML5 QR code library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>üîç Check Passenger Payment</h1>
  <div class="section">
    <button id="scanBtn">üì∑ Scan Trip QR</button>
    <label for="tripSelect">Or select trip:</label>
    <select id="tripSelect">
      <option value="">Loading trips‚Ä¶</option>
    </select>

    <label for="phoneInput">Passenger Phone:</label>
    <input type="text" id="phoneInput" placeholder="e.g. 0978123456" />

    <button id="checkBtn">‚úÖ Check Payment</button>

    <div id="message"></div>

    <!-- Scanner viewport (hidden until you click Scan) -->
    <div id="scanner" style="display:none;"></div>
  </div>

  <script>
    const BASE_URL = 'https://quickfare-backend.onrender.com';
    const tripSelect  = document.getElementById('tripSelect');
    const phoneInput  = document.getElementById('phoneInput');
    const scanBtn     = document.getElementById('scanBtn');
    const checkBtn    = document.getElementById('checkBtn');
    const messageEl   = document.getElementById('message');
    const scannerEl   = document.getElementById('scanner');
    let html5Scanner;

    // Utility
    function showMessage(txt, type='error') {
      messageEl.textContent = txt;
      messageEl.className = type;
    }
    function clearMessage() {
      showMessage('');
    }

    // 1. Load trips for the dropdown
    async function loadTrips() {
      try {
        const res = await fetch(`${BASE_URL}/api/public-trips`);
        if (!res.ok) throw new Error('Failed to load trips');
        const trips = await res.json();
        tripSelect.innerHTML = '<option value="">-- Select a trip --</option>'
          + trips.map(t => `<option value="${t.id}">${t.origin} ‚Üí ${t.destination} | ${new Date(t.date).toLocaleDateString()} ${t.time}</option>`).join('');
      } catch (err) {
        tripSelect.innerHTML = '<option value="">‚ùå Could not load trips</option>';
        console.error(err);
      }
    }

    // 2. Start camera & QR scanner (back camera only)
    scanBtn.addEventListener('click', () => {
      clearMessage();
      scanBtn.disabled = true;
      scannerEl.style.display = 'block';
      html5Scanner = html5Scanner || new Html5Qrcode('scanner');

      html5Scanner.start(
        { facingMode: 'environment' },    // ‚Üê force back camera
        { fps: 10, qrbox: 250 },
        decodedText => {
          // on success
          try {
            const obj = JSON.parse(decodedText);
            if (obj.id) {
              tripSelect.value = obj.id;
              showMessage('‚úÖ Trip selected from QR', 'success');
            } else {
              throw new Error();
            }
          } catch {
            showMessage('‚ö†Ô∏è Invalid QR payload');
          }
          html5Scanner.stop();
          scannerEl.style.display = 'none';
          scanBtn.disabled = false;
        },
        errorMsg => {
          // optionally handle scan failures
          // console.log('Scan fail:', errorMsg);
        }
      ).catch(err => {
        showMessage('‚ùå Scanner init error: ' + err);
        scannerEl.style.display = 'none';
        scanBtn.disabled = false;
      });
    });

    // 3. Check payment on button click
    checkBtn.addEventListener('click', async () => {
      clearMessage();
      const tripId = tripSelect.value;
      const phone  = phoneInput.value.trim();

      if (!tripId || !phone) {
        return showMessage('Please select a trip and enter a phone number.');
      }

      try {
        const res = await fetch(`${BASE_URL}/api/payments/check?tripId=${tripId}&phone=${phone}`);
        if (res.ok) {
          const data = await res.json();
          showMessage(`‚úÖ Payment found: ${data.payment.paymentMethod} (${data.payment.status}) on ${new Date(data.payment.createdAt).toLocaleString()}`, 'success');
        } else {
          const err = await res.json();
          showMessage(`‚ùå ${err.message || 'Not paid'}`);
        }
      } catch (err) {
        console.error(err);
        showMessage('‚ùå Error checking payment.');
      }
    });

    // Initialize
    window.addEventListener('DOMContentLoaded', loadTrips);
  </script>
</body>
</html>
