<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üîç Check Passenger Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    .section {
      max-width: 500px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    label, select, input, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      font-size: 1rem;
    }
    select, input { padding: 8px; }
    button { padding: 10px; cursor: pointer; }
    #scanner { margin-top: 20px; }
    #message { margin-top: 20px; font-size: 1rem; }
    #message.success { color: green; }
    #message.error   { color: red; }
  </style>

  <!-- HTML5-QRCode (make sure this loads before our script!) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>üîç Check Passenger Payment</h1>
  <div class="section">
    <button id="scanBtn">üì∑ Scan Trip QR</button>

    <label for="tripSelect">Or select trip:</label>
    <select id="tripSelect">
      <option>Loading trips‚Ä¶</option>
    </select>

    <label for="phoneInput">Passenger Phone:</label>
    <input type="text" id="phoneInput" placeholder="e.g. 0978123456">

    <button id="checkBtn">‚úÖ Check Payment</button>

    <div id="message"></div>
    <div id="scanner" style="display:none;"></div>
  </div>

  <script>
    const BACKEND = 'https://quickfare-backend.onrender.com';
    const tripSelect = document.getElementById('tripSelect');
    const phoneInput = document.getElementById('phoneInput');
    const scanBtn    = document.getElementById('scanBtn');
    const checkBtn   = document.getElementById('checkBtn');
    const msgEl      = document.getElementById('message');
    const scannerEl  = document.getElementById('scanner');
    let scanner;

    function showMessage(txt, type='error') {
      msgEl.textContent = txt;
      msgEl.className = type;
    }
    function clearMessage() {
      msgEl.textContent = '';
      msgEl.className = '';
    }

    // 1) Load trips into the dropdown
    async function loadTrips() {
      try {
        const res = await fetch(`${BACKEND}/api/public-trips`);
        if (!res.ok) throw new Error('Failed to fetch trips');
        const trips = await res.json();
        tripSelect.innerHTML = '<option value="">-- Select a trip --</option>' +
          trips.map(t =>
            `<option value="${t.id}">${t.origin} ‚Üí ${t.destination} | ${new Date(t.date).toLocaleDateString()} ${t.time}</option>`
          ).join('');
      } catch (e) {
        console.error(e);
        tripSelect.innerHTML = '<option>‚ùå Could not load trips</option>';
      }
    }

    // 2) Scan QR (back camera only)
    scanBtn.addEventListener('click', () => {
      clearMessage();
      scanBtn.disabled = true;
      scannerEl.style.display = 'block';
      scanner = scanner || new Html5Qrcode('scanner');

      scanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        text => {
          try {
            const obj = JSON.parse(text);
            if (obj.id) {
              tripSelect.value = obj.id;
              showMessage('‚úÖ Trip selected via QR', 'success');
            } else throw 0;
          } catch {
            showMessage('‚ö†Ô∏è Invalid QR payload');
          }
          scanner.stop();
          scannerEl.style.display = 'none';
          scanBtn.disabled = false;
        },
        err => {
          /* ignore decode errors */
        }
      ).catch(err => {
        console.error(err);
        showMessage('‚ùå Scanner error: ' + err);
        scannerEl.style.display = 'none';
        scanBtn.disabled = false;
      });
    });

    // 3) Check Payment
    checkBtn.addEventListener('click', async () => {
      clearMessage();
      const tripId = tripSelect.value;
      const phone  = phoneInput.value.trim();
      if (!tripId || !phone) {
        return showMessage('Please select a trip and enter phone.');
      }

      try {
        const res = await fetch(
          `${BACKEND}/api/payments/check?tripId=${tripId}&phone=${encodeURIComponent(phone)}`
        );
        if (res.ok) {
          const data = await res.json();
          const p = data.payment;
          showMessage(
            `‚úÖ ${p.paymentMethod} ${p.status} on ${new Date(p.createdAt).toLocaleString()}`,
            'success'
          );
        } else {
          const e = await res.json();
          showMessage(`‚ùå ${e.message||'Payment not found'}`);
        }
      } catch (e) {
        console.error(e);
        showMessage('‚ùå Network error checking payment');
      }
    });

    // initialize
    window.addEventListener('DOMContentLoaded', loadTrips);
  </script>
</body>
</html>
