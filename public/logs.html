<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuickFare – View Logs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    .card {
      background:#fff; max-width:400px; margin:auto;
      padding:20px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    h1 { text-align:center; margin-bottom:1em; }
    label, select, input, button {
      width:100%; margin:8px 0; padding:8px; box-sizing:border-box;
      border:1px solid #ccc; border-radius:4px;
    }
    button { background:#007BFF; color:#fff; border:none; cursor:pointer; }
    button:disabled { background:#ccc; cursor:not-allowed; }
    .entry { background:#e7f3ff; padding:10px; border-radius:4px; margin-top:1em; }
    .success { color:green; }
    .error   { color:red; }
  </style>
</head>
<body>
  <div class="card">
    <h1>View Payment Logs</h1>

    <label for="tripSelect">Select Trip:</label>
    <select id="tripSelect">
      <option>Loading trips…</option>
    </select>

    <label for="phoneInput">Customer Phone:</label>
    <input type="text" id="phoneInput" placeholder="e.g. 0978123456" />

    <button id="checkBtn" disabled>✅ Check Payment</button>

    <div id="result"></div>
  </div>

  <script>
    const BASE = 'https://quickfare-backend.onrender.com';
    let trips = [];

    // 1) Load public trips into selector
    async function loadTrips() {
      const sel = document.getElementById('tripSelect');
      try {
        const res = await fetch(`${BASE}/api/public-trips`);
        trips = await res.json();
        sel.innerHTML = '<option value="">-- Select a trip --</option>';
        trips.forEach(t => {
          const date = t.date.split('T')[0];
          const time = t.time;
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = `${t.origin} ➜ ${t.destination} | ${date} ${time}`;
          sel.appendChild(opt);
        });
      } catch (e) {
        sel.innerHTML = '<option>Failed to load trips</option>';
        console.error(e);
      }
    }

    // 2) Enable the “Check” button once both fields have values
    function updateButtonState() {
      const trip   = document.getElementById('tripSelect').value;
      const phone  = document.getElementById('phoneInput').value.trim();
      document.getElementById('checkBtn').disabled = !(trip && phone);
    }
    document.getElementById('tripSelect').addEventListener('change', updateButtonState);
    document.getElementById('phoneInput').addEventListener('input', updateButtonState);

    // 3) On Check click, hit the “/api/payments/check” endpoint
    document.getElementById('checkBtn').addEventListener('click', async () => {
      const tripId = document.getElementById('tripSelect').value;
      const phone  = document.getElementById('phoneInput').value.trim();
      const resDiv = document.getElementById('result');
      resDiv.textContent = '';

      try {
        const res = await fetch(`${BASE}/api/payments/check?tripId=${tripId}&phone=${encodeURIComponent(phone)}`);
        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          resDiv.innerHTML = `
            <div class="entry success">
              <strong>✅ Payment found!</strong><br>
              Amount: ZMW ${data.payment.amount || data.payment.amountPaid}<br>
              Method: ${data.payment.paymentMethod || data.payment.method}<br>
              At: ${new Date(data.payment.createdAt).toLocaleString()}
            </div>
          `;
        } else {
          resDiv.innerHTML = `<div class="entry error">❌ ${data.message || data.error}</div>`;
        }
      } catch (err) {
        console.error(err);
        resDiv.innerHTML = `<div class="entry error">❌ Network/server error.</div>`;
      }
    });

    // Initialize
    window.addEventListener('DOMContentLoaded', loadTrips);
  </script>
</body>
</html>
