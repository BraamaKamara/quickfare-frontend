<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuickFare ‚Äì Scan & Go to Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f4f4f4; }
    .card {
      max-width:480px;
      margin:1em auto;
      background:#fff;
      border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      padding:20px;
      text-align:center;
    }
    h1 { margin-bottom:1em; }
    #reader {
      width: 100%;
      height: 60vh;
      margin-bottom:1em;
    }
    #debugLog {
      background:#222;
      color:#0f0;
      font-size:12px;
      text-align:left;
      padding:8px;
      max-height:150px;
      overflow:auto;
      white-space:pre-wrap;
      margin-top:10px;
    }
    #scanError {
      color:red;
      margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Scan &amp; Go to Payment</h1>
    <div id="reader"></div>
    <pre id="debugLog">üìü Waiting for scans‚Ä¶</pre>
    <div id="scanError"></div>
  </div>

  <!-- html5-qrcode (v2.3.6) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.6/html5-qrcode.min.js"></script>
  <script>
    const debugLog   = document.getElementById('debugLog');
    const scanError  = document.getElementById('scanError');
    let   html5QrCode;

    function log(msg) {
      debugLog.textContent += '\n' + msg;
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    function onScanSuccess(decodedText, decodedResult) {
      log('‚úÖ Decoded: ' + decodedText);
      html5QrCode.pause().catch(()=>{});
      // 1) Direct URL?
      if (decodedText.startsWith('http')) {
        log('‚û°Ô∏è Redirecting to URL');
        return window.location.href = decodedText;
      }
      // 2) JSON payload?
      try {
        const obj = JSON.parse(decodedText);
        if (obj.tripId) {
          const target = `${location.origin}/pay.html?tripId=${encodeURIComponent(obj.tripId)}`;
          log('‚û°Ô∏è Redirecting to: ' + target);
          return window.location.href = target;
        }
        throw new Error('Missing tripId');
      } catch (err) {
        scanError.textContent = '‚ùå Invalid QR payload';
        log('‚ùå Invalid payload: ' + err);
        html5QrCode.resume().catch(()=>{});
      }
    }

    function onScanFailure(error) {
      // Log each frame-level failure
      log('‚ö†Ô∏è scan error: ' + error);
    }

    // Initialize camera + scanner
    Html5Qrcode.getCameras()
      .then(cameras => {
        if (!cameras || cameras.length === 0) {
          scanError.textContent = '‚ùå No cameras found';
          return log('‚ùå getCameras(): none');
        }
        // pick back-facing if available
        const backCam = cameras.find(c=>c.label.toLowerCase().includes('back'));
        const cam     = backCam || cameras[0];
        log('üé• Using camera: ' + cam.label);

        html5QrCode = new Html5Qrcode('reader');
        // **NOTE**: we omit `qrbox` so the entire frame is scanned
        html5QrCode.start(
          cam.id,
          { fps: 10 },       // scan 10 times/sec
          onScanSuccess,
          onScanFailure
        )
        .then(() => log('‚úÖ Scanner started'))
        .catch(err => {
          scanError.textContent = '‚ùå Scanner failed to start';
          log('‚ùå start() error: ' + err);
        });
      })
      .catch(err => {
        scanError.textContent = '‚ùå Camera init error';
        log('‚ùå getCameras() error: ' + err);
      });
  </script>
</body>
</html>
